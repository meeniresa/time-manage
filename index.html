<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚é–“è¨ˆç®—å™¨ (PWA)</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#C71585"> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    :root {
        --primary-color: #C71585; 
        --secondary-color: #8A2BE2; 
        --text-color: #4B3832; 
        --background-color: #FFFFFF; 
        --input-bg: #F5F5F5; 
        --font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', Arial, sans-serif;
        --container-bg: rgba(250, 250, 250, 0.95); 
        --active-toggle-color: #28a745; 
        --inactive-toggle-color: #dc3545; 
        --cloud-color: #17a2b8; 
    }

    body {
        font-family: var(--font-family);
        background-color: var(--background-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .container {
        width: 100%;
        max-width: 1300px; 
        padding: 30px;
        border-radius: 10px;
        background-color: var(--container-bg);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
        color: var(--primary-color);
        text-align: center;
        border-bottom: 2px solid var(--secondary-color);
        padding-bottom: 15px;
        margin-bottom: 30px;
    }

    .cloud-panel {
        background: #f0faff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--cloud-color);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    button {
        background-color: var(--primary-color);
        color: #FFFFFF;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s, transform 0.1s;
        white-space: nowrap; 
    }

    button:hover {
        background-color: var(--secondary-color);
        transform: translateY(-1px);
    }
    
    .delete-btn { background-color: #a30000; padding: 5px 10px; font-size: 14px; margin: 2px 1px; }
    .delete-btn:hover { background-color: #d10000; }
    .edit-btn, .save-edit-btn { background-color: #007bff; padding: 5px 10px; font-size: 14px; margin: 2px 1px; }
    .cancel-edit-btn { background-color: #555; padding: 5px 10px; font-size: 14px; margin: 2px 1px; }
    .cancel-edit-btn:hover { background-color: #333; }
    .edit-btn:hover, .save-edit-btn:hover { background-color: #0056b3; }

    .section-title {
        color: var(--secondary-color);
        font-size: 1.5em;
        margin-top: 25px;
        margin-bottom: 15px;
        padding-left: 10px;
        border-left: 4px solid var(--primary-color);
    }

    #current-time-display {
        text-align: center;
        font-size: 1.8em;
        margin-bottom: 20px;
        color: var(--primary-color);
    }
    
    .save-section {
        display: flex;
        align-items: center; 
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap; 
    }

    #save-name, #save-attribute, #save-coordinate {
        flex-grow: 1;
        min-width: 120px;
    }
    
    .invitation-toggle-group {
        display: flex;
        align-items: center;
        border: 1px solid var(--primary-color);
        border-radius: 5px;
        overflow: hidden;
    }

    .invitation-toggle-group label {
        padding: 8px 12px;
        background-color: #fff;
        color: var(--text-color);
        font-weight: bold;
    }
    
    .invitation-toggle, .invitation-toggle-table {
        padding: 8px 12px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
        margin: 0; 
        border-radius: 0;
        white-space: nowrap;
        color: #FFFFFF;
    }
    
    .invitation-toggle.is-active-yes, .invitation-toggle-table.is-active-yes { background-color: var(--active-toggle-color); }
    .invitation-toggle.is-active-no, .invitation-toggle-table.is-active-no { background-color: var(--inactive-toggle-color); }
    .invitation-toggle:not(.is-active-yes):not(.is-active-no), 
    .invitation-toggle-table:not(.is-active-yes):not(.is-active-no) { background-color: #ccc; color: #000; }

    .time-input-container input,
    .control-panel select,
    #save-name, #save-attribute, #save-coordinate,
    #stored-times-table input[type="text"],
    #excel-file-name { 
        background-color: var(--input-bg);
        color: var(--text-color);
        border: 1px solid var(--secondary-color);
        padding: 8px;
        border-radius: 4px;
        font-size: 16px;
        box-sizing: border-box;
    }

    .time-input-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }
    .time-input-container > div {
        display: flex;
        flex-direction: column;
        min-width: 100px;
        flex-grow: 1;
    }
    .time-input-container label {
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .control-panel {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    #stored-times-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        table-layout: fixed; 
    }

    #stored-times-table th, #stored-times-table td {
        border: 1px solid #ddd; 
        padding: 10px;
        text-align: left;
        vertical-align: middle;
        word-wrap: break-word; 
        color: var(--text-color);
    }
    
    #stored-times-table th {
        background-color: var(--secondary-color);
        color: #FFFFFF; 
        cursor: pointer;
    }
    
#batch-delete-btn {
    background-color: #dc3545;
    color: white;
    padding: 8px 15px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    margin-bottom: 10px;
    transition: 0.3s;
}

#batch-delete-btn:hover {
    background-color: #a71d2a;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}


    #result-display {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--primary-color);
        padding: 10px;
        border: 1px dashed var(--secondary-color);
        margin-bottom: 20px;
        text-align: center;
        background-color: var(--input-bg);
        border-radius: 4px;
    }

        /* 4x4 çŸ©é™£æ¨£å¼ */
        .task-grid {
            display: grid;
            grid-template-columns: 120px repeat(4, 1fr);
            gap: 8px;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .grid-header { background: #6c757d; color: white; padding: 10px; border-radius: 4px; text-align: center; font-weight: bold; }
        .row-label { display: flex; align-items: center; justify-content: center; background: #e9ecef; border-radius: 4px; font-weight: bold; }
        .cell { background: white; border: 1px solid #ced4da; padding: 10px; border-radius: 4px; font-size: 0.9em; text-align: center; }
        .cell input { margin-top: 5px; width: 45px; padding: 3px; text-align: center; border: 1px solid var(--secondary-color); border-radius: 4px; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; word-wrap: break-word; }
        th { background: var(--secondary-color); color: white; cursor: pointer; white-space: nowrap; }


    /* èª¿æ•´æ¬„å¯¬ä»¥å®¹ç´æ–°æ¬„ä½ */
#stored-times-table th:nth-child(1) { width: 35px; }  /* å‹¾é¸æ¡† */
#stored-times-table th:nth-child(2) { width: 40px; }  /* ç·¨è™Ÿ */
#stored-times-table th:nth-child(3) { width: 15%; }  /* åç¨± */
#stored-times-table th:nth-child(4) { width: 7%; }  /* å±¬æ€§ */
#stored-times-table th:nth-child(5) { width: 12%; }  /* åº§æ¨™ */
#stored-times-table th:nth-child(6) { width: 70px; }  /* é‚€è«‹ */
#stored-times-table th:nth-child(7) { width: 170px; } /* è¨ˆç®—å¾Œæ™‚é–“ (å»ºè­°çµ¦å›ºå®šå¯¬åº¦é¿å…æŠ˜è¡Œ) */
#stored-times-table th:nth-child(8) { width: 100px; } /* å‰©é¤˜æ™‚é–“ */
#stored-times-table th:nth-child(9) { width: 60px; } /* ä»»å‹™éšæ®µ */
#stored-times-table th:nth-child(10) { width: 110px; } /* æ“ä½œ */

</style>
</head>
<body>

<div class="container">
    <h1>â° æ™‚é–“è¨ˆç®—èˆ‡ç®¡ç†</h1>
    <div id="current-time-display">è¼‰å…¥ä¸­...</div>

    <div class="section-title" style="border-left-color: var(--cloud-color);">â˜ï¸ é›²ç«¯åŒæ­¥è¨­å®š</div>
    <div class="cloud-panel">
        <label for="user-id-input" style="font-weight: bold;">ä½¿ç”¨è€… ID:</label>
        <input type="text" id="user-id-input" placeholder="è¼¸å…¥å°ˆå±¬ ID é€²è¡ŒåŒæ­¥">
        <button onclick="loadFromCloud(event)" style="background-color: var(--cloud-color);">è®€å–é›²ç«¯è³‡æ–™</button>
        <button onclick="uploadToCloud(event)" style="background-color: var(--active-toggle-color);">å„²å­˜ç›®å‰åˆ—è¡¨è‡³é›²ç«¯</button>
    </div>

    <div class="section-title">â±ï¸ è¨ˆç®—å™¨</div>
    
    <div id="excel-file-name-container">
        <label for="excel-file-name" style="font-weight: bold;">æª”æ¡ˆåç¨±:</label>
        <input type="text" id="excel-file-name" placeholder="è¼¸å…¥ Excel æª”æ¡ˆåç¨± (é¸å¡«)">
    </div>

    <div class="control-panel input-group">
        <label for="operation-type">é‹ç®—:</label>
        <select id="operation-type">
            <option value="add">åŠ  (+)</option>
            <option value="subtract">æ¸› (-)</option>
        </select>
        <button onclick="calculateTime()">è¨ˆç®—æ™‚é–“</button>
        <button onclick="clearInputs()" style="background-color: #555;">æ¸…é™¤</button>
    </div>

    <div class="time-input-container">
        <div><label for="days">æ—¥ (Days)</label><input type="number" id="days" value="0" min="0"></div>
        <div><label for="hours">æ™‚ (Hours)</label><input type="number" id="hours" value="0" min="0"></div>
        <div><label for="minutes">åˆ† (Minutes)</label><input type="number" id="minutes" value="0" min="0"></div>
        <div><label for="seconds">ç§’ (Seconds)</label><input type="number" id="seconds" value="0" min="0"></div>
    </div>

    <div class="section-title">âœ¨ è¨ˆç®—çµæœ</div>
    <div id="result-display">è¨ˆç®—çµæœå°‡é¡¯ç¤ºåœ¨æ­¤ (YYYY-MM-DD HH:MM:SS)</div>

    <div class="section-title">ğŸ’¾ å„²å­˜è¨ˆç®—çµæœ</div>
    <div class="save-section">
        <input type="text" id="save-name" placeholder="è¼¸å…¥åç¨±">
        <input type="text" id="save-attribute" placeholder="è¼¸å…¥å±¬æ€§">
        <input type="text" id="save-coordinate" placeholder="è¼¸å…¥åº§æ¨™">
        
        <div class="invitation-toggle-group">
            <label>é‚€è«‹:</label>
            <button id="invite-yes-btn" class="invitation-toggle" onclick="setInvitationStatus(true)">æ˜¯</button>
            <button id="invite-no-btn" class="invitation-toggle" onclick="setInvitationStatus(false)">å¦</button>
        </div>

        <button onclick="saveTime()">å„²å­˜åˆ°æ¸…å–®</button>
    </div>

<div class="section">
    <div class="section-title">ğŸ¯ ä»»å‹™é€²åº¦ç›®æ¨™ </div>
    <div class="task-grid" id="goal-matrix">
        <div class="grid-header">éšæ®µ \ ä»»å‹™</div>
        <div class="grid-header">ä»»å‹™ 1</div><div class="grid-header">ä»»å‹™ 2</div>
        <div class="grid-header">ä»»å‹™ 3</div><div class="grid-header">ä»»å‹™ 4</div>

        <div class="row-label">ç¬¬ 1 éšæ®µ</div>
        <div class="cell">1-1<br><input type="number" id="g1-1" value="0" min="0" max="10"></div>
        <div class="cell">1-2<br><input type="number" id="g1-2" value="0" min="0" max="10"></div>
        <div class="cell">1-3<br><input type="number" id="g1-3" value="0" min="0" max="10"></div>
        <div class="cell">1-4<br><input type="number" id="g1-4" value="2" min="0" max="10"></div>

        <div class="row-label">ç¬¬ 2 éšæ®µ</div>
        <div class="cell">2-1<br><input type="number" id="g2-1" value="0" min="0" max="10"></div>
        <div class="cell">2-2<br><input type="number" id="g2-2" value="2" min="0" max="10"></div>
        <div class="cell">2-3<br><input type="number" id="g2-3" value="3" min="0" max="10"></div>
        <div class="cell">2-4<br><input type="number" id="g2-4" value="4" min="0" max="10"></div>

        <div class="row-label">ç¬¬ 3 éšæ®µ</div>
        <div class="cell">3-1<br><input type="number" id="g3-1" value="0" min="0" max="10"></div>
        <div class="cell">3-2<br><input type="number" id="g3-2" value="3" min="0" max="10"></div>
        <div class="cell">3-3<br><input type="number" id="g3-3" value="4" min="0" max="10"></div>
        <div class="cell">3-4<br><input type="number" id="g3-4" value="5" min="0" max="10"></div>

        <div class="row-label">ç¬¬ 4 éšæ®µ</div>
        <div class="cell">4-1<br><input type="number" id="g4-1" value="3" min="0" max="10"></div>
        <div class="cell">4-2<br><input type="number" id="g4-2" value="4" min="0" max="10"></div>
        <div class="cell">4-3<br><input type="number" id="g4-3" value="4" min="0" max="10"></div>
        <div class="cell">4-4<br><input type="number" id="g4-4" value="5" min="0" max="10"></div>
    </div>

    <div class="status-setting">
        <strong>ğŸš€ èµ·å§‹é€²åº¦ï¼š</strong>
        ç›®å‰åœ¨ç¬¬ <select id="start-round"><option>1</option><option>2</option><option>3</option><option>4</option></select> éš -ä»»å‹™ 
        <select id="start-stage"><option>1</option><option>2</option><option>3</option><option>4</option></select> ï¼Œ
        å·²é”æˆ: <input type="number" id="start-attained" value="0" min="0" style="width:50px"> å€‹
        <button onclick="refreshTaskAssignment()">ğŸ”„ è¨ˆç®—ä»»å‹™åˆ†é…</button>
    </div>
</div>

<div style="margin: 10px 0; display: flex; justify-content: flex-end;">
    <button id="batch-delete-btn" onclick="batchDelete()" style="background-color: #dc3545; display: none;">
        ğŸ—‘ï¸ åˆªé™¤é¸å–é …ç›® (<span id="select-count">0</span>)
    </button>
</div>

    <div class="section-title">ğŸ“‹ å„²å­˜é …ç›®æ¸…å–®</div>
    <table id="stored-times-table">
        <thead>
            <tr>
		<th style="width: 40px;"><input type="checkbox" id="select-all" onclick="toggleSelectAll(this)"></th>
                <th>ç·¨è™Ÿ</th>
                <th>åç¨±</th>
                <th>å±¬æ€§</th>
                <th>åº§æ¨™</th>
                <th>é‚€è«‹</th>
                <th onclick="sortTable(5)">æ™‚é–“ ğŸ•’</th>
                <th>å‰©é¤˜ â³</th>
		<th>ä»»å‹™éšæ®µ</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="time-list-body"></tbody>
    </table>

    <div class="file-operation">
        <div class="section-title" style="margin-top: 25px;">ğŸ“‚ è³‡æ–™æª”æ¡ˆæ“ä½œ (Excel)</div>
        <button onclick="exportToExcel()">åŒ¯å‡º Excel (xlsx)</button>
        <input type="file" id="import-file" accept=".xlsx" style="display: none;" onchange="importFromExcel(event)">
        <button onclick="document.getElementById('import-file').click()">åŒ¯å…¥ Excel (xlsx)</button>
    </div>
</div>

<script>

// åœ¨ script é–‹é ­æˆ– DOMContentLoaded åŠ å…¥
document.addEventListener('DOMContentLoaded', () => {
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
    renderTable();
});

    const GAS_URL = "https://script.google.com/macros/s/AKfycbzBgl-VFYh-a-534FymV_NuqKcJvupEtFZoT7sDf9a7nKTsJpbiC4e4196tMGyZUpLgHw/exec";
    let storedTimes = []; 
    let currentSortDirection = 'asc'; 
    let editingId = null; 
    let currentInvitationStatus = false; 

    // --- é›²ç«¯åŒæ­¥ ---
    async function uploadToCloud(e) {
        const userID = document.getElementById('user-id-input').value.trim();
        if (!userID) return alert("è«‹è¼¸å…¥ä½¿ç”¨è€… IDï¼");
        const btn = e.target;
        btn.textContent = "ä¸Šå‚³ä¸­...";
        try {
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "saveAll", userID: userID, data: storedTimes })
            });
            alert("é›²ç«¯åŒæ­¥æˆåŠŸï¼");
        } catch (e) { alert("åŒæ­¥å¤±æ•—ã€‚"); }
        btn.textContent = "å„²å­˜ç›®å‰åˆ—è¡¨è‡³é›²ç«¯";
    }

    async function loadFromCloud(e) {
        const userID = document.getElementById('user-id-input').value.trim();
        if (!userID) return alert("è«‹è¼¸å…¥ä½¿ç”¨è€… IDï¼");
        const btn = e.target;
        btn.textContent = "è®€å–ä¸­...";
        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "loadAll", userID: userID })
            });
            const cloudData = await response.json();
            storedTimes = cloudData.map(item => {
                let parsedDate = new Date(item.timeString);
                if (isNaN(parsedDate)) {
                    let safeTimeString = item.timeString.replace(/-/g, '/').replace('T', ' ').replace(/\..+/, '');
                    parsedDate = new Date(safeTimeString);
                }
                return {
                    ...item,
                    time: parsedDate,
                    timeString: formatTime(parsedDate),
                    coordinate: item.coordinate || '' // ç¢ºä¿åº§æ¨™æ¬„ä½å­˜åœ¨
                };
            });
            renderTable();
            alert("è®€å–æˆåŠŸï¼");
        } catch (e) { alert("è®€å–å¤±æ•—ã€‚"); }
        btn.textContent = "è®€å–é›²ç«¯è³‡æ–™";
    }

    // --- åŠŸèƒ½å‡½å¼ ---

function sendNotification(item) {
    if (Notification.permission === "granted") {
        const notification = new Notification("â° æ™‚é–“åˆ°æœŸæé†’ï¼", {
            body: `é …ç›®ï¼š${item.name}\nåº§æ¨™ï¼š${item.coordinate || 'ç„¡'}\nå±¬æ€§ï¼š${item.attribute}`,
            icon: "https://cdn-icons-png.flaticon.com/512/1827/1827347.png" // å¯æ›æˆæ‚¨å–œæ­¡çš„åœ–ç¤º
        });

        // é»æ“Šé€šçŸ¥å¯ä»¥è·³å›ç¶²é åˆ†é 
        notification.onclick = function() {
            window.focus();
            this.close();
        };
    }
}

    function setInvitationStatus(status) {
        currentInvitationStatus = status;
        document.getElementById('invite-yes-btn').className = 'invitation-toggle' + (status ? ' is-active-yes' : '');
        document.getElementById('invite-no-btn').className = 'invitation-toggle' + (!status ? ' is-active-no' : '');
    }
    
    function formatTime(date) {
        if (!date || isNaN(date)) return "ç„¡æ•ˆæ™‚é–“";
        const f = (n) => String(n).padStart(2, '0');
        return `${date.getFullYear()}-${f(date.getMonth() + 1)}-${f(date.getDate())} ${f(date.getHours())}:${f(date.getMinutes())}:${f(date.getSeconds())}`;
    }

    function formatTimeDifference(targetDate) {
        const diffMs = targetDate.getTime() - new Date().getTime();
        const isFuture = diffMs > 0;
        const s = Math.floor(Math.abs(diffMs) / 1000);
        const m = Math.floor(s / 60);
        const h = Math.floor(m / 60);
        const d = Math.floor(h / 24);
        let res = d > 0 ? `${d}å¤©${h%24}æ™‚${m%60}åˆ†${s%60}ç§’` : h > 0 ? `${h}æ™‚${m%60}åˆ†${s%60}ç§’` : `${m}åˆ†${s%60}ç§’`;
        return `<span style="color: ${isFuture ? 'var(--active-toggle-color)' : 'var(--inactive-toggle-color)'}; font-weight: bold;">${isFuture ? 'é‚„æœ‰' : 'å·²é'} ${res}</span>`;
    }

function calculateTime() {
    // 1. å–å¾—è¼¸å…¥æ•¸å€¼
    const d = parseInt(document.getElementById('days').value) || 0;
    const h = parseInt(document.getElementById('hours').value) || 0;
    const m = parseInt(document.getElementById('minutes').value) || 0;
    const s = parseInt(document.getElementById('seconds').value) || 0;
    const operationType = document.getElementById('operation-type').value;

    // 2. è¨ˆç®—ç¸½æ¯«ç§’æ•¸
    const ms = (d * 86400000) + (h * 3600000) + (m * 60000) + (s * 1000);
    
    // 3. æ ¹æ“šé‹ç®—é¡å‹è¨ˆç®—çµæœæ™‚é–“
    const now = new Date().getTime();
    const resDate = new Date(operationType === 'add' ? now + ms : now - ms);
    
    // 4. å»ºç«‹æ™‚é–“å·®å­—ä¸² (Delta String)
    const deltaString = `${d}æ—¥${h}æ™‚${m}åˆ†${s}ç§’`;

    // 5. æ›´æ–°é¡¯ç¤ºä»‹é¢èˆ‡æš«å­˜å±¬æ€§
    const disp = document.getElementById('result-display');
    
    // ä¿®æ­£å­—ä¸²æ‹¼æ¥èªæ³•
    disp.textContent = `${formatTime(resDate)} (${deltaString})`;
    
    // å„²å­˜è³‡æ–™ä¾›å¾ŒçºŒã€Œå„²å­˜åˆ°æ¸…å–®ã€åŠŸèƒ½ä½¿ç”¨
    disp.calculatedDate = resDate;
    disp.timeDeltaString = deltaString;
}

    function saveTime() {
        const resDisp = document.getElementById('result-display');
        if (!resDisp.calculatedDate) return alert('è«‹å…ˆè¨ˆç®—æ™‚é–“ï¼');
        const newItem = {
            id: Date.now(),
            name: document.getElementById('save-name').value.trim() || 'æœªå‘½å',
            attribute: document.getElementById('save-attribute').value.trim() || 'ç„¡',
            coordinate: document.getElementById('save-coordinate').value.trim() || '', // å„²å­˜åº§æ¨™
            isInvited: currentInvitationStatus,
            time: resDisp.calculatedDate,
            timeString: formatTime(resDisp.calculatedDate)

        };
        storedTimes.push(newItem);
        renderTable();
        document.getElementById('save-name').value = '';
        document.getElementById('save-attribute').value = '';
        document.getElementById('save-coordinate').value = '';
    }

function saveEdit(id) {
    const itemIndex = storedTimes.findIndex(item => item.id === id);
    if (itemIndex === -1) return;

    const newName = document.getElementById(`edit-name-${id}`).value.trim();
    const newAttribute = document.getElementById(`edit-attribute-${id}`).value.trim();
    const newCoordinate = document.getElementById(`edit-coordinate-${id}`).value.trim(); // æ–°å¢åº§æ¨™
    const newTimeString = document.getElementById(`edit-time-${id}`).value.trim();
    
    // å¾æŒ‰éˆ•ç‹€æ…‹è®€å–ç•¶å‰é‚€è«‹ç‹€æ…‹
    const invitedStatus = document.getElementById(`btn-inv-${id}`).classList.contains('is-active-yes');

    // è§£ææ™‚é–“å­—ä¸²
    const dateToParse = newTimeString.replace(/-/g, '/');
    const newTime = new Date(dateToParse);
    
    if (isNaN(newTime)) {
        alert('æ™‚é–“æ ¼å¼ç„¡æ•ˆï¼Œè«‹ä½¿ç”¨ YYYY-MM-DD HH:MM:SS');
        return;
    }
    
    // æ›´æ–°è³‡æ–™æ¨¡å‹
    storedTimes[itemIndex].name = newName || 'æœªå‘½åé …ç›®';
    storedTimes[itemIndex].attribute = newAttribute || 'ç„¡å±¬æ€§';
    storedTimes[itemIndex].coordinate = newCoordinate;
    storedTimes[itemIndex].isInvited = invitedStatus;
    storedTimes[itemIndex].time = newTime;
    storedTimes[itemIndex].timeString = formatTime(newTime);
    
    editingId = null; 
    renderTable(); 
}

// å…¨é¸/å…¨ä¸é¸åŠŸèƒ½
function toggleSelectAll(masterCheckbox) {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(cb => cb.checked = masterCheckbox.checked);
    updateBatchDeleteBtn();
}

// æ›´æ–°æ‰¹æ¬¡åˆªé™¤æŒ‰éˆ•ç‹€æ…‹
function updateBatchDeleteBtn() {
    const selectedCount = document.querySelectorAll('.item-checkbox:checked').length;
    const btn = document.getElementById('batch-delete-btn');
    const countSpan = document.getElementById('select-count');
    
    if (!btn) return; // é˜²æ­¢ HTML å°šæœªå»ºç«‹æ™‚å ±éŒ¯

    if (selectedCount > 0) {
        btn.style.display = 'inline-block';
        if (countSpan) countSpan.textContent = selectedCount;
    } else {
        btn.style.display = 'none';
        // å¦‚æœæ‰‹å‹•å–æ¶ˆæ‰€æœ‰å‹¾é¸ï¼Œä¹Ÿè¦å–æ¶ˆæ¨™é ­çš„ã€Œå…¨é¸ã€å‹¾é¸
        const selectAllBox = document.getElementById('select-all');
        if (selectAllBox) selectAllBox.checked = false;
    }
}

// åŸ·è¡Œæ‰¹æ¬¡åˆªé™¤
function batchDelete() {
    const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
    if (selectedCheckboxes.length === 0) return;

    if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${selectedCheckboxes.length} å€‹é …ç›®å—ï¼Ÿ`)) return;

    // å–å¾—æ‰€æœ‰å‹¾é¸çš„ ID
    const idsToDelete = Array.from(selectedCheckboxes).map(cb => Number(cb.value));

    // éæ¿¾æ‰é¸ä¸­çš„ ID
    storedTimes = storedTimes.filter(item => !idsToDelete.includes(item.id));

    // é‡ç½®å…¨é¸æ¡†èˆ‡æ›´æ–°è¡¨æ ¼
    const selectAllBox = document.getElementById('select-all');
    if (selectAllBox) selectAllBox.checked = false;

    renderTable();
    updateBatchDeleteBtn();
}

function refreshTaskAssignment() {
    const now = Date.now();
    
    // 1. å–å¾—æ‰€æœ‰æœªåˆ°æœŸé …ç›®ï¼Œä¸¦æŒ‰å‰©é¤˜æ™‚é–“ç”±å°åˆ°å¤§æ’åº (ä¸éè£œåŸå‰‡ï¼šè¨ˆç®—ç•¶ä¸‹çš„å¿«ç…§)
    let activeItems = storedTimes.filter(item => item.time.getTime() > now)
                                 .sort((a, b) => a.time - b.time);
    
    // 2. å–å¾—èµ·å§‹ä½ç½®
    let r = parseInt(document.getElementById('start-round').value);
    let s = parseInt(document.getElementById('start-stage').value);
    let attained = parseInt(document.getElementById('start-attained').value);
    let extraCount = 1;

    // å–å¾—ç›®æ¨™æ•¸é‡çš„è¼”åŠ©å‡½å¼
    const getGoal = (round, stage) => parseInt(document.getElementById(`g${round}-${stage}`).value) || 0;

    // 3. é€ä¸€åˆ†é…æ¨™ç±¤
    activeItems.forEach(item => {
        let assigned = false;
        
        while (r <= 4) {
            let goal = getGoal(r, s);
            
            if (attained < goal) {
                // è©²éšæ®µé‚„æœ‰ç¼ºå£ï¼Œåˆ†é…é€²å»
                item.taskStage = `${r}-${s}`;
                attained++;
                assigned = true;
                break; 
            } else {
                // è©²éšæ®µå·²æ»¿ï¼Œç§»å‹•åˆ°ä¸‹ä¸€å€‹éšæ®µ
                attained = 0;
                s++;
                if (s > 4) { s = 1; r++; }
            }
        }
        
        // å¦‚æœ 4-4 éƒ½è·‘å®Œäº†é‚„æœ‰å‰©é¤˜é …ç›®ï¼Œæ¨™è¨˜ç‚ºè¶…é¡
        if (!assigned) {
            item.taskStage = `è¶…é¡é …ç›®${String(extraCount++).padStart(2, '0')}`;
        }
    });

    // 4. å·²åˆ°æœŸçš„é …ç›®å°‡æ¨™ç±¤æ¸…ç©º
    storedTimes.forEach(item => {
        if (item.time.getTime() <= now) {
            item.taskStage = '';
        }
    });

    // 5. é‡æ–°æ¸²æŸ“è¡¨æ ¼
    renderTable();
}


function renderTable() {
    const body = document.getElementById('time-list-body');
    body.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼

    storedTimes.forEach((item, index) => {
        const row = body.insertRow();
        row.setAttribute('data-id', item.id);
        const isEditing = editingId === item.id;

        // --- ç¬¬ 0 æ¬„ï¼šå‹¾é¸æ¡† (æ‰¹æ¬¡åˆªé™¤ç”¨) ---
        const cCheck = row.insertCell(0);
        cCheck.style.textAlign = 'center';
        cCheck.innerHTML = `<input type="checkbox" class="item-checkbox" value="${item.id}" onchange="updateBatchDeleteBtn()">`;

        // --- ç¬¬ 1 æ¬„ï¼šç·¨è™Ÿ ---
        row.insertCell(1).textContent = index + 1;
        
        // --- å®šç¾©å…¶é¤˜å–®å…ƒæ ¼ ---
        const cName = row.insertCell(2);
        const cAttr = row.insertCell(3);
        const cCoord = row.insertCell(4);
        const cInv = row.insertCell(5);
        const cTime = row.insertCell(6);
        const cDiff = row.insertCell(7);
        const cStage = row.insertCell(8);
        const cOpt = row.insertCell(9);

        if (isEditing) {
            // --- ç·¨è¼¯æ¨¡å¼ ---
            cName.innerHTML = `<input type="text" id="edit-name-${item.id}" value="${item.name}" style="width:90%">`;
            cAttr.innerHTML = `<input type="text" id="edit-attribute-${item.id}" value="${item.attribute}" style="width:90%">`;
            cCoord.innerHTML = `<input type="text" id="edit-coordinate-${item.id}" value="${item.coordinate || ''}" style="width:90%">`;
            
            const statusClass = item.isInvited ? 'is-active-yes' : 'is-active-no';
            cInv.innerHTML = `
                <button onclick="toggleEditInv(${item.id})" id="btn-inv-${item.id}" 
                        class="invitation-toggle-table ${statusClass}">
                    ${item.isInvited ? 'æ˜¯' : 'å¦'}
                </button>`;
            cInv.style.textAlign = 'center';

            cTime.innerHTML = `<input type="text" id="edit-time-${item.id}" value="${item.timeString}" style="width:95%">`;
            cDiff.textContent = 'ç·¨è¼¯ä¸­...';
            cStage.textContent = item.taskStage;
            
            cOpt.innerHTML = `
                <button class="save-edit-btn" onclick="saveEdit(${item.id})">å„²å­˜</button>
                <button class="cancel-edit-btn" onclick="editingId=null;renderTable()">å–æ¶ˆ</button>`;
        } else {
            // --- é¡¯ç¤ºæ¨¡å¼ ---
            cName.textContent = item.name;
            cAttr.textContent = item.attribute;
            cCoord.textContent = item.coordinate || ''; // é¡¯ç¤ºåº§æ¨™
            
            cInv.textContent = item.isInvited ? 'âœ… æ˜¯' : 'âŒ å¦';
            cInv.style.textAlign = 'center';

            cTime.textContent = item.timeString;
            cDiff.innerHTML = formatTimeDifference(item.time);
            cStage.textContent = item.taskStage;
            
            cOpt.innerHTML = `
                <button class="edit-btn" onclick="editingId=${item.id};renderTable()">ä¿®æ”¹</button>
                <button class="delete-btn" onclick="deleteTime(${item.id})">åˆªé™¤</button>`;
        }
    });

    // æ¯æ¬¡é‡æ–°ç¹ªè£½å¾Œï¼Œæª¢æŸ¥æ‰¹æ¬¡åˆªé™¤æŒ‰éˆ•æ˜¯å¦è©²é¡¯ç¤º
    if (typeof updateBatchDeleteBtn === 'function') {
        updateBatchDeleteBtn();
    }
}

    function deleteTime(id) {
        if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { storedTimes = storedTimes.filter(i => i.id !== id); renderTable(); }
    }

    function toggleEditInv(id) {
        const idx = storedTimes.findIndex(i => i.id === id);
        storedTimes[idx].isInvited = !storedTimes[idx].isInvited;
        const btn = document.getElementById(`btn-inv-${id}`);
        btn.textContent = storedTimes[idx].isInvited ? 'æ˜¯' : 'å¦';
        btn.className = `invitation-toggle-table ${storedTimes[idx].isInvited?'is-active-yes':'is-active-no'}`;
    }

    function sortTable(n) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        storedTimes.sort((a,b) => (currentSortDirection==='asc'?1:-1) * (a.time - b.time));
        renderTable();
    }

    // --- Excel ---
    function exportToExcel() {
        const data = [["ç·¨è™Ÿ", "åç¨±", "å±¬æ€§", "åº§æ¨™", "é‚€è«‹", "æ™‚é–“"]];
        storedTimes.forEach((item, i) => data.push([i+1, item.name, item.attribute, item.coordinate, item.isInvited?'æ˜¯':'å¦', item.timeString]));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "æ¸…å–®");
        XLSX.writeFile(wb, (document.getElementById('excel-file-name').value || "æ™‚é–“è¡¨") + ".xlsx");
    }

    function importFromExcel(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const sheet = XLSX.read(ev.target.result, {type:'array'}).Sheets[XLSX.read(ev.target.result, {type:'array'}).SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, {header:1, range:1});
            storedTimes = json.filter(r => r.length >= 6).map(r => ({
                id: Date.now() + Math.random(),
                name: String(r[1]),
                attribute: String(r[2]),
                coordinate: String(r[3] || ''),
                isInvited: r[4] === 'æ˜¯',
                time: new Date(String(r[5]).replace(/-/g, '/')),
                timeString: String(r[5])
            }));
            renderTable();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function clearInputs() {
        ['days','hours','minutes','seconds'].forEach(id => document.getElementById(id).value = 0);
        document.getElementById('result-display').textContent = 'è¨ˆç®—çµæœå°‡é¡¯ç¤ºåœ¨æ­¤';
        document.getElementById('result-display').calculatedDate = null;
    }

setInterval(() => {
    const now = new Date().getTime();
    document.getElementById('current-time-display').textContent = 'ç•¶å‰æ™‚é–“: ' + formatTime(new Date());

    if (editingId === null) {
        const rows = document.getElementById('time-list-body').rows;
        Array.from(rows).forEach(row => {
            const id = row.getAttribute('data-id');
            const item = storedTimes.find(i => i.id == id);
            
            if (item) {
                // æ›´æ–°å‰©é¤˜æ™‚é–“é¡¯ç¤º
                row.cells[7].innerHTML = formatTimeDifference(item.time);

                // --- æ–°å¢ï¼šé€šçŸ¥åˆ¤æ–·é‚è¼¯ ---
                const diffMs = item.time.getTime() - now;
                
                // å¦‚æœè·é›¢åˆ°æœŸå‰©é¤˜ä¸åˆ° 1 ç§’ï¼Œä¸”å°šæœªç™¼é€éé€šçŸ¥
                if (diffMs <= 60000 && diffMs > -20000 && !item.notified) {
                    sendNotification(item);
                    item.notified = true; // æ¨™è¨˜ç‚ºå·²é€šçŸ¥ï¼Œé¿å…é‡è¤‡è§¸ç™¼
                }
            }
        });
    }
}, 1000);

    document.addEventListener('DOMContentLoaded', renderTable);
</script>
</body>
</html>