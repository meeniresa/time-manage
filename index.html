<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚é–“è¨ˆç®—å™¨ (PWA)</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#C71585"> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    /* 1. é¡è‰²èª¿æ•´: é»‘è‰²èƒŒæ™¯ -> ç™½è‰²ï¼Œç™½è‰²æ–‡å­— -> æ·±å’–å•¡è‰² */
    :root {
        --primary-color: #C71585; 
        --secondary-color: #8A2BE2; 
        --text-color: #4B3832; /* æ·±å’–å•¡è‰² */
        --background-color: #FFFFFF; /* ç™½è‰²èƒŒæ™¯ */
        --input-bg: #F5F5F5; /* æ·ºè‰²è¼¸å…¥èƒŒæ™¯ */
        --font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', Arial, sans-serif;
        --container-bg: rgba(250, 250, 250, 0.95); /* æ·ºè‰²å®¹å™¨èƒŒæ™¯ */
        --active-toggle-color: #28a745; /* ç¶ è‰²ï¼Œè¡¨ç¤ºã€Œæ˜¯ã€ */
        --inactive-toggle-color: #dc3545; /* ç´…è‰²ï¼Œè¡¨ç¤ºã€Œå¦ã€ */
        --cloud-color: #17a2b8; /* æ–°å¢é›²ç«¯è‰²ç³» */
    }

    body {
        font-family: var(--font-family);
        background-color: var(--background-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .container {
        width: 100%;
        max-width: 1200px; 
        padding: 30px;
        border-radius: 10px;
        background-color: var(--container-bg);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); /* èª¿æ•´é™°å½±ä»¥é©æ‡‰æ·ºè‰²èƒŒæ™¯ */
    }

    h1 {
        color: var(--primary-color);
        text-align: center;
        border-bottom: 2px solid var(--secondary-color);
        padding-bottom: 15px;
        margin-bottom: 30px;
    }

        /* é›²ç«¯å€å¡Šå°ˆå±¬æ¨£å¼ */
        .cloud-panel {
            background: #f0faff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--cloud-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

    button {
        background-color: var(--primary-color);
        color: #FFFFFF; /* æŒ‰éˆ•æ–‡å­—ä¿æŒç™½è‰²ä»¥å¢åŠ å°æ¯” */
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s, transform 0.1s;
        white-space: nowrap; 
    }

    button:hover {
        background-color: var(--secondary-color);
        transform: translateY(-1px);
    }
    
    .delete-btn {
        background-color: #a30000; 
        padding: 5px 10px;
        font-size: 14px;
        /* ä¿æŒåœ¨è¡¨æ ¼å…§ï¼Œä¸¦ç¸®å° margin */
        margin: 2px 1px; 
    }

    .delete-btn:hover {
        background-color: #d10000;
    }
    
    .edit-btn, .save-edit-btn {
        background-color: #007bff; 
        padding: 5px 10px;
        font-size: 14px;
        /* ä¿æŒåœ¨è¡¨æ ¼å…§ï¼Œä¸¦ç¸®å° margin */
        margin: 2px 1px;
    }
    
    /* æ–°å¢å–æ¶ˆæŒ‰éˆ•æ¨£å¼ */
    .cancel-edit-btn {
        background-color: #555;
        padding: 5px 10px;
        font-size: 14px;
        margin: 2px 1px;
    }
    .cancel-edit-btn:hover {
        background-color: #333;
    }

    .edit-btn:hover, .save-edit-btn:hover {
        background-color: #0056b3;
    }

    .section-title {
        color: var(--secondary-color);
        font-size: 1.5em;
        margin-top: 25px;
        margin-bottom: 15px;
        padding-left: 10px;
        border-left: 4px solid var(--primary-color);
    }

    #current-time-display {
        text-align: center;
        font-size: 1.8em;
        margin-bottom: 20px;
        color: var(--primary-color);
    }
    
    .save-section {
        display: flex;
        align-items: center; 
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap; 
    }

    #save-name, #save-attribute {
        flex-grow: 1;
        min-width: 150px;
    }
    
    /* æ˜¯å¦é‚€è«‹æŒ‰éˆ•æ¨£å¼ (è¨ˆç®—å™¨ä¸Šæ–¹) */
    .invitation-toggle-group {
        display: flex;
        align-items: center;
        border: 1px solid var(--primary-color);
        border-radius: 5px;
        overflow: hidden;
    }

    .invitation-toggle-group label {
        padding: 8px 12px;
        background-color: #fff;
        color: var(--text-color);
        font-weight: bold;
    }
    
    .invitation-toggle, .invitation-toggle-table {
        padding: 8px 12px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
        margin: 0; 
        border-radius: 0;
        white-space: nowrap;
        color: #FFFFFF;
    }
    
    .invitation-toggle.is-active-yes, .invitation-toggle-table.is-active-yes {
        background-color: var(--active-toggle-color);
    }
    .invitation-toggle.is-active-no, .invitation-toggle-table.is-active-no {
        background-color: var(--inactive-toggle-color);
    }
    .invitation-toggle:not(.is-active-yes):not(.is-active-no), 
    .invitation-toggle-table:not(.is-active-yes):not(.is-active-no) {
        background-color: #ccc;
        color: #000;
    }

    .time-input-container input,
    .control-panel select,
    #save-name, #save-attribute,
    #stored-times-table input[type="text"],
    #excel-file-name { 
        background-color: var(--input-bg);
        color: var(--text-color);
        border: 1px solid var(--secondary-color);
        padding: 8px;
        border-radius: 4px;
        font-size: 16px;
        box-sizing: border-box;
    }

    /* ç¢ºä¿è¡¨æ ¼ä¸­çš„ç´”æ–‡å­—è¼¸å…¥æ¡†å¯¬åº¦é©ä¸­ */
    #stored-times-table input[type="text"],
    #stored-times-table input[type="text-time"] {
        padding: 4px;
        font-size: 14px;
    }
    
    .time-input-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }
    .time-input-container > div {
        display: flex;
        flex-direction: column;
        min-width: 100px;
        flex-grow: 1;
    }
    .time-input-container label {
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .control-panel {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .control-panel > * {
        margin: 5px 0;
    }

    /* æª”æ¡ˆåç¨±è¼¸å…¥æ¬„ä½æ¨£å¼ */
    #excel-file-name-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    #excel-file-name {
        flex-grow: 1;
        min-width: 200px;
    }

    #stored-times-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        table-layout: fixed; 
    }

    #stored-times-table th,
    #stored-times-table td {
        border: 1px solid #ddd; 
        padding: 10px;
        text-align: left;
        vertical-align: middle;
        word-wrap: break-word; 
        color: var(--text-color);
    }
    
    #stored-times-table th {
        background-color: var(--secondary-color);
        color: #FFFFFF; 
        cursor: pointer;
        position: sticky;
        top: 0;
    }
    
    /* è¡¨æ ¼å…§çš„æ“ä½œæ¬„ä½ç½®ä¸­ */
    #stored-times-table td:last-child {
        text-align: center;
    }
    
    /* è®“è¨ˆç®—çµæœçš„æ–‡å­—é¡è‰²æ›´æ˜é¡¯ */
    #result-display {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--primary-color);
        padding: 10px;
        border: 1px dashed var(--secondary-color);
        margin-bottom: 20px;
        text-align: center;
        background-color: var(--input-bg);
        border-radius: 4px;
    }

    /* èª¿æ•´è¡¨æ ¼æ¬„å¯¬ä»¥é©æ‡‰æ–°å¢çš„æ™‚é–“å·®æ¬„ä½ */
    #stored-times-table thead tr th:nth-child(4) { width: 10%; } /* æ˜¯å¦é‚€è«‹ */
    #stored-times-table thead tr th:nth-child(5) { width: 20%; } /* è¨ˆç®—å¾Œæ™‚é–“ */
    #stored-times-table thead tr th:nth-child(6) { width: 20%; } /* æ™‚é–“å·® */
    #stored-times-table thead tr th:nth-child(7) { width: 15%; } /* æ“ä½œ */

    /* èª¿æ•´è¡¨æ ¼å…§ã€Œæ˜¯å¦é‚€è«‹ã€çš„æŒ‰éˆ•æ¨£å¼ï¼Œç¢ºä¿å…¶ä¸æœƒå¤ªå¯¬ */
    #stored-times-table .invitation-toggle-table {
        padding: 5px 8px; /* ç¸®å°å¡«å…… */
        font-size: 13px; /* ç¸®å°å­—é«” */
        margin: 0 auto; /* ç½®ä¸­ */
        /* ç§»é™¤ display: block; è®“æŒ‰éˆ•å¯¬åº¦è·Ÿéš¨å…§å®¹ */
        display: inline-block; 
    }
</style>
</head>
<body>

<div class="container">
    <h1>â° æ™‚é–“è¨ˆç®—èˆ‡ç®¡ç†</h1>
    <div id="current-time-display">è¼‰å…¥ä¸­...</div>

    <div class="section-title" style="border-left-color: var(--cloud-color);">â˜ï¸ é›²ç«¯åŒæ­¥è¨­å®š</div>
    <div class="cloud-panel">
        <label for="user-id-input" style="font-weight: bold;">ä½¿ç”¨è€… ID:</label>
        <input type="text" id="user-id-input" placeholder="è¼¸å…¥å°ˆå±¬ ID é€²è¡ŒåŒæ­¥">
        <button onclick="loadFromCloud()" style="background-color: var(--cloud-color);">è®€å–é›²ç«¯è³‡æ–™</button>
        <button onclick="uploadToCloud()" style="background-color: var(--active-toggle-color);">å„²å­˜ç›®å‰åˆ—è¡¨è‡³é›²ç«¯</button>
    </div>

    <div class="section-title">â±ï¸ è¨ˆç®—å™¨</div>
    
    <div id="excel-file-name-container">
        <label for="excel-file-name" style="font-weight: bold;">æª”æ¡ˆåç¨±:</label>
        <input type="text" id="excel-file-name" placeholder="è¼¸å…¥ Excel æª”æ¡ˆåç¨± (é¸å¡«)">
    </div>

    <div class="control-panel input-group">
        <label for="operation-type">é‹ç®—:</label>
        <select id="operation-type">
            <option value="add">åŠ  (+)</option>
            <option value="subtract">æ¸› (-)</option>
        </select>
        <button onclick="calculateTime()">è¨ˆç®—æ™‚é–“</button>
        <button onclick="clearInputs()" style="background-color: #555;">æ¸…é™¤</button>
    </div>

    <div class="time-input-container">
        <div><label for="days">æ—¥ (Days)</label><input type="number" id="days" value="0" min="0"></div>
        <div><label for="hours">æ™‚ (Hours)</label><input type="number" id="hours" value="0" min="0"></div>
        <div><label for="minutes">åˆ† (Minutes)</label><input type="number" id="minutes" value="0" min="0"></div>
        <div><label for="seconds">ç§’ (Seconds)</label><input type="number" id="seconds" value="0" min="0"></div>
    </div>

    <div class="section-title">âœ¨ è¨ˆç®—çµæœ</div>
    <div id="result-display">è¨ˆç®—çµæœå°‡é¡¯ç¤ºåœ¨æ­¤ (YYYY-MM-DD HH:MM:SS)</div>

    <div class="section-title">ğŸ’¾ å„²å­˜è¨ˆç®—çµæœ</div>
    <div class="save-section">
        <input type="text" id="save-name" placeholder="è¼¸å…¥å„²å­˜åç¨±">
        <input type="text" id="save-attribute" placeholder="è¼¸å…¥å±¬æ€§">
        
        <div class="invitation-toggle-group">
            <label>æ˜¯å¦é‚€è«‹:</label>
            <button id="invite-yes-btn" class="invitation-toggle" onclick="setInvitationStatus(true)">æ˜¯</button>
            <button id="invite-no-btn" class="invitation-toggle" onclick="setInvitationStatus(false)">å¦</button>
        </div>

        <button onclick="saveTime()">å„²å­˜åˆ°æ¸…å–®</button>
    </div>

    <div class="section-title">ğŸ“‹ å„²å­˜é …ç›®æ¸…å–®</div>
    <table id="stored-times-table">
<thead>
        <tr>
            <th style="width: 5%;">ç·¨è™Ÿ</th>
            <th style="width: 20%;">åç¨±</th>
            <th style="width: 15%;">å±¬æ€§</th> 
            <th style="width: 10%;">æ˜¯å¦é‚€è«‹</th> 
            <th onclick="sortTable(4)" style="width: 20%;">è¨ˆç®—å¾Œæ™‚é–“ ğŸ•’</th>
            <th style="width: 20%;">å‰©é¤˜æ™‚é–“ â³</th> 
            <th style="width: 10%;">æ“ä½œ</th> 
        </tr>
    </thead>
        <tbody id="time-list-body"></tbody>
    </table>

    <div class="file-operation">
        <div class="section-title" style="margin-top: 25px;">ğŸ“‚ è³‡æ–™æª”æ¡ˆæ“ä½œ (Excel)</div>
        <button onclick="exportToExcel()">åŒ¯å‡º Excel (xlsx)</button>
        <input type="file" id="import-file" accept=".xlsx" style="display: none;" onchange="importFromExcel(event)">
        <button onclick="document.getElementById('import-file').click()">åŒ¯å…¥ Excel (xlsx)</button>
    </div>

</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzBgl-VFYh-a-534FymV_NuqKcJvupEtFZoT7sDf9a7nKTsJpbiC4e4196tMGyZUpLgHw/exec";
    let storedTimes = []; 
    let currentSortDirection = 'asc'; 
    let editingId = null; 
    let currentInvitationStatus = false; 

    // --- é›²ç«¯åŒæ­¥å‡½å¼ ---
    async function uploadToCloud() {
        const userID = document.getElementById('user-id-input').value.trim();
        if (!userID) return alert("è«‹è¼¸å…¥ä½¿ç”¨è€… ID æ‰èƒ½å„²å­˜åˆ°é›²ç«¯ï¼");
        const btn = event.target;
        btn.textContent = "ä¸Šå‚³ä¸­...";
        try {
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "saveAll", userID: userID, data: storedTimes })
            });
            alert("é›²ç«¯åŒæ­¥æˆåŠŸï¼è³‡æ–™å·²å„²å­˜è‡³ ID: " + userID);
        } catch (e) { alert("åŒæ­¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– GAS è¨­å®šã€‚"); }
        btn.textContent = "å„²å­˜ç›®å‰åˆ—è¡¨è‡³é›²ç«¯";
    }

    async function loadFromCloud() {
        const userID = document.getElementById('user-id-input').value.trim();
        if (!userID) return alert("è«‹è¼¸å…¥ä½¿ç”¨è€… ID æ‰èƒ½è®€å–è³‡æ–™ï¼");
        const btn = event.target;
        btn.textContent = "è®€å–ä¸­...";
        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "loadAll", userID: userID })
            });
            const cloudData = await response.json();
            storedTimes = cloudData.map(item => ({ ...item, time: new Date(item.time) }));
            renderTable();
            alert("å·²å¾é›²ç«¯è¼‰å…¥ ID: " + userID + " çš„è³‡æ–™ï¼");
        } catch (e) { alert("è®€å–å¤±æ•—ï¼ŒæŸ¥ç„¡è³‡æ–™æˆ–æ¬Šé™å•é¡Œã€‚"); }
        btn.textContent = "è®€å–é›²ç«¯è³‡æ–™";
    }

    // --- æ™‚é–“æ ¼å¼åŒ–èˆ‡æ ¸å¿ƒæ™‚é–“å·®è¨ˆç®— ---
    
    function setInvitationStatus(status) {
        currentInvitationStatus = status;
        const yesBtn = document.getElementById('invite-yes-btn');
        const noBtn = document.getElementById('invite-no-btn');

        yesBtn.classList.remove('is-active-yes', 'is-active-no');
        noBtn.classList.remove('is-active-yes', 'is-active-no');

        if (status) {
            yesBtn.classList.add('is-active-yes');
        } else {
            noBtn.classList.add('is-active-no');
        }
    }
    
    function formatTime(date) {
        if (!date || isNaN(date)) return "ç„¡æ•ˆæ™‚é–“";
        const Y = date.getFullYear();
        const M = String(date.getMonth() + 1).padStart(2, '0');
        const D = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const m = String(date.getMinutes()).padStart(2, '0');
        const s = String(date.getSeconds()).padStart(2, '0');
        return `${Y}-${M}-${D} ${h}:${m}:${s}`;
    }

    // *** èª¿æ•´ï¼šä¸å†æ ¼å¼åŒ–ç‚º datetime-local æ ¼å¼ï¼Œè€Œæ˜¯æ¨™æº–çš„ YYYY-MM-DD HH:MM:SS ***
    function formatTimeForEdit(date) {
        if (!date || isNaN(date)) return '';
        const Y = date.getFullYear();
        const M = String(date.getMonth() + 1).padStart(2, '0');
        const D = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const m = String(date.getMinutes()).padStart(2, '0');
        const s = String(date.getSeconds()).padStart(2, '0');
        // è¿”å›æ˜“è®€çš„æ ¼å¼ï¼Œè®“ä½¿ç”¨è€…ç›´æ¥ç·¨è¼¯
        return `${Y}-${M}-${D} ${h}:${m}:${s}`; 
    }

    function formatTimeDifference(targetDate) {
        const now = new Date().getTime();
        const target = targetDate.getTime();
        let diffMs = target - now;
        const isFuture = diffMs > 0;
        diffMs = Math.abs(diffMs);

        const s = Math.floor(diffMs / 1000);
        const m = Math.floor(s / 60);
        const h = Math.floor(m / 60);
        const d = Math.floor(h / 24);

        const sec = s % 60;
        const min = m % 60;
        const hour = h % 24;

        let parts = [];
        if (d > 0) parts.push(`${d}å¤©`);
        if (hour > 0) parts.push(`${hour}æ™‚`);
        if (min > 0) parts.push(`${min}åˆ†`);
        
        // åƒ…ç•¶å¤©æ•¸ã€å°æ™‚ã€åˆ†é˜éƒ½ç‚ºé›¶æ™‚ï¼Œæ‰é¡¯ç¤ºç§’æ•¸
        if (d === 0 && hour === 0 && min === 0) {
             parts.push(`${sec}ç§’`);
        } else {
             // å¦å‰‡ï¼Œåœ¨æœ€å°å–®ä½é¡¯ç¤ºå‰å…©ä½
             if (parts.length < 3) parts.push(`${sec}ç§’`);
        }
        
        const timeDiffString = parts.length > 0 ? parts.slice(0, 3).join('') : 'å³æ™‚';

        if (isFuture) {
            return `<span style="color: var(--active-toggle-color); font-weight: bold;">é‚„æœ‰ ${timeDiffString}</span>`;
        } else {
            return `<span style="color: var(--inactive-toggle-color); font-weight: bold;">å·²é ${timeDiffString}</span>`;
        }
    }
    // --- é é¢æ™‚é–“æ›´æ–°é‚è¼¯ ---
    
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time-display').textContent = 'ç•¶å‰æ™‚é–“: ' + formatTime(now);
    }
    
    // å®šæ™‚æ›´æ–°æ™‚é–“å·®
    function updateTimeDifferences() {
        const rows = document.getElementById('time-list-body').rows;
        Array.from(rows).forEach(row => {
            const id = parseInt(row.getAttribute('data-id'));
            const item = storedTimes.find(i => i.id === id);
            
            // æª¢æŸ¥æ™‚é–“å·®é¡¯ç¤ºå–®å…ƒæ ¼æ˜¯å¦å­˜åœ¨ (ç¬¬ 6 æ¬„)
            const diffCell = row.cells[5]; 
            
            if (item && diffCell && editingId !== id) {
                diffCell.innerHTML = formatTimeDifference(item.time);
            }
        });
    }

    // è¨­å®šæ¯ç§’æ›´æ–°ç•¶å‰æ™‚é–“å’Œæ‰€æœ‰é …ç›®çš„æ™‚é–“å·®
    setInterval(() => {
        updateCurrentTime();
        updateTimeDifferences();
    }, 1000);
    updateCurrentTime(); // ç«‹å³å‘¼å«ä¸€æ¬¡

    // --- è¨ˆç®—å™¨èˆ‡å„²å­˜é‚è¼¯ (ä¿æŒä¸è®Š) ---
    
    function clearInputs() {
        document.getElementById('days').value = 0;
        document.getElementById('hours').value = 0;
        document.getElementById('minutes').value = 0;
        document.getElementById('seconds').value = 0;
        document.getElementById('operation-type').value = 'add';

        const resultDisplay = document.getElementById('result-display');
        resultDisplay.textContent = 'è¨ˆç®—çµæœå°‡é¡¯ç¤ºåœ¨æ­¤ (YYYY-MM-DD HH:MM:SS)';
        resultDisplay.calculatedDate = null; 
        resultDisplay.timeDeltaString = ''; 

        setInvitationStatus(false);
    }

    function calculateTime() {
        const days = parseInt(document.getElementById('days').value) || 0;
        const hours = parseInt(document.getElementById('hours').value) || 0;
        const minutes = parseInt(document.getElementById('minutes').value) || 0;
        const seconds = parseInt(document.getElementById('seconds').value) || 0;
        const operationType = document.getElementById('operation-type').value;

        const timeDeltaMs = (days * 24 * 60 * 60 * 1000) + (hours * 60 * 60 * 1000) + (minutes * 60 * 1000) + (seconds * 1000);
        const now = new Date();
        let calculatedTime = (operationType === 'add') 
            ? new Date(now.getTime() + timeDeltaMs) 
            : new Date(now.getTime() - timeDeltaMs);
        
        // å»ºç«‹æ™‚é–“å·®å­—ä¸²
        const deltaString = `${days}æ—¥${hours}æ™‚${minutes}åˆ†${seconds}ç§’`;

        const resultDisplay = document.getElementById('result-display');
        resultDisplay.textContent = `${formatTime(calculatedTime)} (${deltaString})`;
        resultDisplay.calculatedDate = calculatedTime;
        resultDisplay.timeDeltaString = deltaString; 
    }

    function saveTime() {
        const resultDisplay = document.getElementById('result-display');
        const calculatedDate = resultDisplay.calculatedDate;

        if (!calculatedDate || isNaN(calculatedDate)) {
            alert('è«‹å…ˆé»æ“Šã€Œè¨ˆç®—æ™‚é–“ã€å–å¾—æœ‰æ•ˆçš„çµæœã€‚');
            return;
        }

        const name = document.getElementById('save-name').value.trim() || 'æœªå‘½åé …ç›®';
        const attribute = document.getElementById('save-attribute').value.trim() || 'ç„¡å±¬æ€§'; 
        const isInvited = currentInvitationStatus; 

        const newItem = {
            id: Date.now(),
            name: name,
            attribute: attribute, 
            isInvited: isInvited, 
            time: calculatedDate, 
            timeString: formatTime(calculatedDate), 
        };

        storedTimes.push(newItem);
        sortTable(4, 'asc'); 
        
        document.getElementById('save-name').value = ''; 
        document.getElementById('save-attribute').value = '';
        setInvitationStatus(false); 
    }
    
    function deleteTime(id) {
        if (editingId === id) {
            alert('è«‹å…ˆå„²å­˜æˆ–é€€å‡ºç·¨è¼¯æ¨¡å¼ï¼Œå†é€²è¡Œåˆªé™¤ã€‚');
            return;
        }
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ')) return;
        storedTimes = storedTimes.filter(item => item.id !== id);
        renderTable(); 
    }
    
    function editTime(id) {
        if (editingId !== null && editingId !== id) {
            alert('è«‹å…ˆå„²å­˜æˆ–å–æ¶ˆç›®å‰æ­£åœ¨ç·¨è¼¯çš„é …ç›®ã€‚');
            return;
        }
        editingId = id;
        renderTable();
    }
    
    function saveEdit(id) {
        const itemIndex = storedTimes.findIndex(item => item.id === id);
        if (itemIndex === -1) return;

        const newName = document.getElementById(`edit-name-${id}`).value.trim();
        const newAttribute = document.getElementById(`edit-attribute-${id}`).value.trim();
        // *** ä¿®æ”¹ï¼šå¾ type="text" è®€å–æ™‚é–“å­—ä¸² ***
        const newTimeString = document.getElementById(`edit-time-${id}`).value.trim();
        const invitedStatus = document.getElementById(`edit-status-${id}`).dataset.status === 'true';

        // è§£ææ–°çš„æ™‚é–“
        // ä½¿ç”¨ replace è™•ç†å¸¸è¦‹çš„æ—¥æœŸåˆ†éš”ç¬¦ (ä¾‹å¦‚å°‡ YYYY-MM-DD HH:MM:SS è½‰ç‚º YYYY/MM/DD HH:MM:SS ä»¥å¢å¼·ç›¸å®¹æ€§)
        const dateToParse = newTimeString.replace(/-/g, '/');
        const newTime = new Date(dateToParse);
        
        if (isNaN(newTime) || newTime.toString() === "Invalid Date") {
            alert('æ™‚é–“æ ¼å¼ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥æ—¥æœŸå’Œæ™‚é–“è¼¸å…¥ï¼è«‹ä½¿ç”¨ YYYY-MM-DD HH:MM:SS æ ¼å¼ã€‚');
            return;
        }
        
        storedTimes[itemIndex].name = newName || 'æœªå‘½åé …ç›®';
        storedTimes[itemIndex].attribute = newAttribute || 'ç„¡å±¬æ€§';
        storedTimes[itemIndex].isInvited = invitedStatus;
        storedTimes[itemIndex].time = newTime;
        storedTimes[itemIndex].timeString = formatTime(newTime);
        
        editingId = null; 
        renderTable(); 
    }

    // æ–°å¢ï¼šå–æ¶ˆç·¨è¼¯
    function cancelEdit() {
        editingId = null;
        renderTable();
    }
    
    function toggleEditInvitation(id) {
        const itemIndex = storedTimes.findIndex(item => item.id === id);
        if (itemIndex === -1) return;

        const currentStatus = storedTimes[itemIndex].isInvited;
        const newStatus = !currentStatus;
        
        storedTimes[itemIndex].isInvited = newStatus;

        const btn = document.getElementById(`edit-status-${id}`);
        btn.textContent = newStatus ? 'æ˜¯' : 'å¦';
        btn.dataset.status = newStatus;
        btn.className = 'invitation-toggle-table'; 
        btn.classList.add(newStatus ? 'is-active-yes' : 'is-active-no');
    }


    // ä¿®æ”¹ï¼šé‡æ–°ç¹ªè£½è¡¨æ ¼ï¼Œç¢ºä¿æŒ‰éˆ•åœ¨æ“ä½œæ¬„ä½å…§ï¼Œä¸”æ™‚é–“ç‚ºç´”æ–‡å­—è¼¸å…¥
    function renderTable() {
        const tableBody = document.getElementById('time-list-body');
        tableBody.innerHTML = ''; 

        storedTimes.forEach((item, index) => {
            const row = tableBody.insertRow();
            row.setAttribute('data-id', item.id);

            row.insertCell(0).textContent = index + 1; 
            const nameCell = row.insertCell(1);
            const attributeCell = row.insertCell(2);
            const invitedCell = row.insertCell(3);
            const timeCell = row.insertCell(4);
            const diffCell = row.insertCell(5); 
            const operationCell = row.insertCell(6);
            operationCell.style.whiteSpace = 'nowrap'; 

            if (editingId === item.id) {
                // --- ç·¨è¼¯æ¨¡å¼ ---
                nameCell.innerHTML = `<input type="text" id="edit-name-${item.id}" value="${item.name.replace(/"/g, '&quot;')}" style="width: 95%;">`;
                attributeCell.innerHTML = `<input type="text" id="edit-attribute-${item.id}" value="${item.attribute.replace(/"/g, '&quot;')}" style="width: 95%;">`;
                
                // *** èª¿æ•´ï¼šä½¿ç”¨ type="text" è®“ä½¿ç”¨è€…ç›´æ¥ç·¨è¼¯æ™‚é–“å­—ä¸² ***
                timeCell.innerHTML = `<input type="text" id="edit-time-${item.id}" value="${formatTimeForEdit(item.time)}" placeholder="YYYY-MM-DD HH:MM:SS" style="width: 95%;">`;
                timeCell.style.fontSize = '0.9em'; 

                diffCell.textContent = 'ç·¨è¼¯ä¸­...';
                
                const statusClass = item.isInvited ? 'is-active-yes' : 'is-active-no';
                invitedCell.innerHTML = `
                    <button 
                        id="edit-status-${item.id}" 
                        class="invitation-toggle-table ${statusClass}" 
                        data-status="${item.isInvited}"
                        onclick="toggleEditInvitation(${item.id})" 
                        title="é»æ“Šåˆ‡æ›é‚€è«‹ç‹€æ…‹">
                        ${item.isInvited ? 'æ˜¯' : 'å¦'}
                    </button>
                `;
                invitedCell.style.textAlign = 'center';

                // *** èª¿æ•´ï¼šæŒ‰éˆ•æ”¾åœ¨ operationCell å…§ ***
                operationCell.innerHTML = `
                    <button class="save-edit-btn" onclick="saveEdit(${item.id})" title="å„²å­˜ä¿®æ”¹">å„²å­˜</button>
                    <button class="cancel-edit-btn" onclick="cancelEdit()" title="æ”¾æ£„ä¿®æ”¹">å–æ¶ˆ</button>
                `;

            } else {
                // --- é¡¯ç¤ºæ¨¡å¼ ---
                nameCell.textContent = item.name;
                attributeCell.textContent = item.attribute;
                
                invitedCell.textContent = item.isInvited ? 'âœ… æ˜¯' : 'âŒ å¦';
                invitedCell.style.textAlign = 'center';

                timeCell.textContent = item.timeString;
                
                diffCell.innerHTML = formatTimeDifference(item.time); 

                // *** èª¿æ•´ï¼šæŒ‰éˆ•æ”¾åœ¨ operationCell å…§ ***
                operationCell.innerHTML = `
                    <button class="edit-btn" onclick="editTime(${item.id})" title="ç·¨è¼¯æ­¤é …ç›®">ä¿®æ”¹</button>
                    <button class="delete-btn" onclick="deleteTime(${item.id})" title="åˆªé™¤æ­¤é …ç›®">åˆªé™¤</button>
                `;
            }
        });
    }

    function sortTable(columnIndex, initialDirection) {
        if (columnIndex !== 4) return; 

        if (initialDirection) {
             currentSortDirection = initialDirection;
        } else {
             currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        }

        storedTimes.sort((a, b) => {
            const timeA = a.time.getTime();
            const timeB = b.time.getTime();

            if (currentSortDirection === 'asc') {
                return timeA - timeB; 
            } else {
                return timeB - timeA; 
            }
        });

        renderTable(); 
    }


    // --- Excel åŒ¯å…¥/åŒ¯å‡ºé‚è¼¯ (ä¿æŒä¸è®Š) ---
    function exportToExcel() {
        if (storedTimes.length === 0) {
            alert('æ¸…å–®ä¸­æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼');
            return;
        }

        const fileNamePrefix = document.getElementById('excel-file-name').value.trim();
        const defaultFileName = "æ™‚é–“è¨ˆç®—çµæœ";
        const baseFileName = fileNamePrefix ? fileNamePrefix.replace(/[^a-zA-Z0-9_\u4e00-\u9fa5]/g, '_') : defaultFileName;
        const dateSuffix = new Date().toISOString().slice(0, 10);
        const finalFileName = `${baseFileName}_${dateSuffix}.xlsx`;

        // Excel æ¨™é ­
        const ws_data = [
            ["ç·¨è™Ÿ", "åç¨±", "å±¬æ€§", "æ˜¯å¦é‚€è«‹", "è¨ˆç®—å¾Œæ™‚é–“"] 
        ];
        
        storedTimes.forEach((item, index) => {
            ws_data.push([
                index + 1, 
                item.name,
                item.attribute, 
                item.isInvited ? 'æ˜¯' : 'å¦', 
                item.timeString, 
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æ™‚é–“è¨ˆç®—çµæœ");

        XLSX.writeFile(wb, finalFileName); 
    }

    function importFromExcel(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                // è®€å–å¾ç¬¬ 2 è¡Œé–‹å§‹çš„æ‰€æœ‰è³‡æ–™ (header: 1, range: 1)
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 1 });

                const importedItems = [];
                json.forEach(row => {
                    // å¿…é ˆè‡³å°‘æœ‰ 5 æ¬„è³‡æ–™ï¼š[ç·¨è™Ÿ, åç¨±, å±¬æ€§, æ˜¯å¦é‚€è«‹, è¨ˆç®—å¾Œæ™‚é–“]
                    if (row.length < 5) return; 

                    const name = String(row[1]).trim();
                    const attribute = String(row[2]).trim() || 'ç„¡å±¬æ€§'; 
                    const invitedText = String(row[3]).toUpperCase().trim();
                    const isInvited = (invitedText === 'æ˜¯' || invitedText === 'TRUE' || invitedText === '1');
                    const timeString = String(row[4]).trim();
                    // ç‚ºäº†ç›¸å®¹æ€§ï¼Œå°‡æ—¥æœŸä¸­çš„ '-' æ›¿æ›ç‚º '/'
                    const dateToParse = timeString.replace(/-/g, '/');
                    const parsedTime = new Date(dateToParse);
                    
                    if (isNaN(parsedTime)) return;

                    importedItems.push({
                        id: Date.now() + Math.random(), 
                        name: name,
                        attribute: attribute, 
                        isInvited: isInvited, 
                        time: parsedTime, 
                        timeString: formatTime(parsedTime),
                    });
                });

                storedTimes = importedItems;
                editingId = null; 
                sortTable(4, 'asc'); 
                alert(`æˆåŠŸåŒ¯å…¥ ${importedItems.length} ç­†è³‡æ–™ï¼`);

            } catch (error) {
                console.error("åŒ¯å…¥ Excel å¤±æ•—:", error);
                alert("åŒ¯å…¥ Excel æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º (.xlsx)ã€‚");
            }
        };

        reader.readAsArrayBuffer(file);
    }



    document.addEventListener('DOMContentLoaded', () => {
        clearInputs();
        updateCurrentTime();
        if(storedTimes.length > 0) {
            sortTable(4, 'asc'); 
        }
        // ç¢ºä¿åœ¨è¼‰å…¥æ™‚é–‹å§‹æ›´æ–°æ™‚é–“å·®
        updateTimeDifferences(); 
    });
</script>
</body>
</html>